// Schema simplificado para desenvolvimento local com SQLite
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Tenants (multi-tenancy)
model Tenant {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  themeConfig  String   @default("{}")  // JSON como String
  settings     String   @default("{}")  // JSON como String
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  users        User[]
  products     Product[]
  templates    Template[]
  assets       Asset[]
  projects     Project[]
  orders       Order[]

  @@map("tenants")
}

// Usu√°rios
model User {
  id            String    @id @default(uuid())
  tenantId      String
  email         String    @unique
  name          String
  password      String
  role          String    @default("user") // 'user', 'admin', 'super_admin'
  active        Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relacionamentos
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assets        Asset[]
  projects      Project[]
  orders        Order[]

  @@map("users")
}

// Produtos
model Product {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  specs       String   @default("{}")  // JSON como String
  rules       String   @default("{}")  // JSON como String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  variants    ProductVariant[]
  projects    Project[]

  @@map("products")
}

// Variantes de Produto
model ProductVariant {
  id         String  @id @default(uuid())
  productId  String
  name       String
  sku        String?
  sizeMm     String  // JSON como String: {width: 300, height: 300}
  paper      String?
  minPages   Int     @default(1)
  maxPages   Int     @default(100)
  basePrice  Float   @default(0)
  priceRules String  @default("{}")  // JSON como String
  active     Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  projects   Project[]

  @@map("product_variants")
}

// Templates
model Template {
  id          String   @id @default(uuid())
  tenantId    String
  productType String
  name        String
  description String?
  layoutJson  String   @default("{}")  // JSON como String
  previewUrl  String?
  version     Int      @default(1)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("templates")
}

// Assets (imagens, etc.)
model Asset {
  id               String   @id @default(uuid())
  userId           String
  tenantId         String
  filename         String
  originalName     String
  mimeType         String
  sizeBytes        Int
  storageKey       String
  url              String?
  width            Int?
  height           Int?
  dpi              Int?
  exifData         String   @default("{}")  // JSON como String
  faces            String   @default("[]")  // JSON como String
  phash            String?
  thumbnailUrls    String   @default("{}")  // JSON como String
  processingStatus String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relacionamentos
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("assets")
}

// Projetos
model Project {
  id            String   @id @default(uuid())
  userId        String
  tenantId      String
  productId     String?
  variantId     String?
  name          String
  status        String   @default("draft") // 'draft', 'completed', 'archived'
  pages         String   @default("[]")    // JSON como String
  settings      String   @default("{}")    // JSON como String
  priceSnapshot String   @default("{}")    // JSON como String
  version       Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product?         @relation(fields: [productId], references: [id])
  variant       ProductVariant?  @relation(fields: [variantId], references: [id])
  orders        OrderItem[]

  @@map("projects")
}

// Pedidos
model Order {
  id            String   @id @default(uuid())
  userId        String?
  tenantId      String
  orderNumber   String   @unique
  status        String   @default("draft") // 'draft', 'pending_payment', 'paid', 'in_production', 'shipped', 'delivered', 'cancelled'
  totalAmount   Float    @default(0)
  currency      String   @default("BRL")
  shippingData  String   @default("{}")  // JSON como String
  billingData   String   @default("{}")  // JSON como String
  paymentRef    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  user          User?      @relation(fields: [userId], references: [id])
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items         OrderItem[]

  @@map("orders")
}

// Itens do Pedido
model OrderItem {
  id              String   @id @default(uuid())
  orderId         String
  projectId       String?
  productId       String?
  variantId       String?
  quantity        Int      @default(1)
  unitPrice       Float
  totalPrice      Float
  productionSpecs String   @default("{}")  // JSON como String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  project         Project? @relation(fields: [projectId], references: [id])

  @@map("order_items")
}