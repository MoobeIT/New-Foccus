// Schema completo para Editor de Fotolivros Profissional
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// MULTI-TENANCY
// ============================================

model Tenant {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  themeConfig  String   @default("{}")
  settings     String   @default("{}")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users        User[]
  products     Product[]
  formats      Format[]
  papers       Paper[]
  coverTypes   CoverType[]
  templates    Template[]
  assets       Asset[]
  projects     Project[]
  orders       Order[]
  auditLogs    AuditLog[]
  coupons      Coupon[]

  @@map("tenants")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(uuid())
  tenantId      String
  email         String    @unique
  name          String
  password      String
  role          String    @default("photographer") // 'photographer', 'operator', 'admin'
  active        Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assets        Asset[]
  projects      Project[]
  orders        Order[]
  orderReviews  Order[]   @relation("OrderReviewer")
  auditLogs     AuditLog[]

  @@map("users")
}


// ============================================
// PRODUCT CATALOG
// ============================================

model Product {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  slug        String?
  type        String   @default("photobook") // 'photobook', 'calendar', 'card', 'poster', 'case'
  category    String?  // 'casamento', 'ensaio', 'newborn', '15anos', 'estojo'
  description String?
  shortDescription String?
  
  // Preços
  basePrice   Float    @default(0)
  basePagesIncluded Int @default(20) // Páginas incluídas no preço base (ex: 20 páginas ou 10 lâminas)
  pricePerExtraPage Float @default(0) // Valor por página/lâmina adicional
  pricePerExtraSpread Float @default(0) // Valor por spread (2 páginas) adicional
  
  // Configurações de páginas
  minPages    Int      @default(20)
  maxPages    Int      @default(100)
  pageIncrement Int    @default(2) // Incremento de páginas (2 = lâminas)
  
  // Características do produto
  features    String   @default("[]") // JSON array de features
  specs       String   @default("[]") // JSON array de especificações {icon, label, value}
  
  // Opções de acabamento
  hasCase     Boolean  @default(false) // Tem opção de estojo
  casePrice   Float    @default(0) // Preço do estojo
  caseDescription String? // Descrição do estojo
  
  // Imagens
  imageUrl    String?
  thumbnailUrl String?
  galleryImages String @default("[]") // JSON array de URLs
  
  // SEO e Marketing
  badge       String?  // 'Mais Vendido', 'Novo', 'Premium'
  tags        String   @default("[]") // JSON array de tags
  seoTitle    String?
  seoDescription String?
  
  // Ordenação e visibilidade
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  isPublished Boolean  @default(false) // Só aparece no site quando publicado
  publishedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  formats     Format[]
  projects    Project[]
  productPapers ProductPaper[]
  productCoverTypes ProductCoverType[]
  orderItems  OrderItem[]

  @@unique([tenantId, slug])
  @@map("products")
}

// Relação N:N entre Produto e Papel com preço específico
model ProductPaper {
  id          String   @id @default(uuid())
  productId   String
  paperId     String
  priceAdjustment Float @default(0) // Ajuste de preço para este papel neste produto
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  paper       Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  @@unique([productId, paperId])
  @@map("product_papers")
}

// Relação N:N entre Produto e Tipo de Capa com preço específico
model ProductCoverType {
  id          String   @id @default(uuid())
  productId   String
  coverTypeId String
  priceAdjustment Float @default(0) // Ajuste de preço para esta capa neste produto
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  coverType   CoverType @relation(fields: [coverTypeId], references: [id], onDelete: Cascade)

  @@unique([productId, coverTypeId])
  @@map("product_cover_types")
}

model Format {
  id            String   @id @default(uuid())
  tenantId      String
  productId     String
  name          String
  width         Float    // mm
  height        Float    // mm
  orientation   String   @default("square") // 'square', 'portrait', 'landscape'
  minPages      Int      @default(20)
  maxPages      Int      @default(200)
  pageIncrement Int      @default(2) // must be multiple of this
  bleed         Float    @default(3) // mm
  safeMargin    Float    @default(5) // mm
  gutterMargin  Float    @default(10) // mm
  basePrice     Float    @default(0) // Preço base do formato (inclui páginas base)
  pricePerExtraPage Float @default(0) // Preço por página extra
  priceMultiplier Float  @default(1.0) // Multiplicador (pode ser usado para ajustes)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  papers        FormatPaper[]
  projects      Project[]

  @@map("formats")
}

model Paper {
  id                String   @id @default(uuid())
  tenantId          String
  name              String
  type              String   @default("photo") // 'photo', 'coated', 'matte', 'recycled'
  weight            Int      // g/m²
  thickness         Float    // mm per sheet (for spine calculation)
  finish            String   @default("glossy") // 'glossy', 'matte', 'satin'
  lamination        String   @default("none") // 'none', 'matte', 'glossy', 'soft_touch'
  pricePerPage      Float    @default(0)
  description       String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  compatibleFormats FormatPaper[]
  projects          Project[]
  productPapers     ProductPaper[]

  @@map("papers")
}

model FormatPaper {
  id        String   @id @default(uuid())
  formatId  String
  paperId   String
  createdAt DateTime @default(now())

  format    Format   @relation(fields: [formatId], references: [id], onDelete: Cascade)
  paper     Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  @@unique([formatId, paperId])
  @@map("format_papers")
}

model CoverType {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  type             String   @default("soft") // 'soft', 'hard', 'premium'
  material         String?  // 'couro', 'tecido', 'papel', 'madeira'
  bindingTolerance Float    @default(0) // mm added to spine
  price            Float    @default(0)
  description      String?
  imageUrl         String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects         Project[]
  productCoverTypes ProductCoverType[]

  @@map("cover_types")
}


// ============================================
// TEMPLATES
// ============================================

model Template {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  productType  String   // 'photobook', 'calendar', etc.
  templateType String   // 'cover', 'page', 'spread'
  category     String   // 'elegant', 'modern', 'minimal', etc.
  description  String?
  previewUrl   String?
  thumbnailUrl String?
  dimensions   String   @default("{}") // JSON: {width, height, unit}
  margins      String   @default("{}") // JSON: {top, right, bottom, left, spine, center}
  safeArea     String   @default("{}") // JSON: {top, right, bottom, left}
  elements     String   @default("[]") // JSON array of template elements
  colors       String   @default("[]") // JSON array of color palette
  fonts        String   @default("[]") // JSON array of font names
  tags         String   @default("[]") // JSON array of tags
  isSystem     Boolean  @default(false) // system template vs user-created
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("templates")
}

// ============================================
// ASSETS (Images)
// ============================================

model Asset {
  id               String   @id @default(uuid())
  userId           String
  tenantId         String
  projectId        String?
  
  // File info
  filename         String
  originalName     String
  mimeType         String
  sizeBytes        Int
  
  // Image properties
  width            Int?     // pixels
  height           Int?     // pixels
  dpi              Int?
  colorProfile     String?  // 'sRGB', 'AdobeRGB', 'CMYK', 'untagged'
  hasAlpha         Boolean  @default(false)
  
  // Storage
  storageKey       String
  url              String?
  thumbnailSmall   String?  // 150px
  thumbnailMedium  String?  // 300px
  thumbnailLarge   String?  // 600px
  
  // Metadata
  exifData         String   @default("{}") // JSON
  processingStatus String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project          Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("assets")
}


// ============================================
// PROJECTS
// ============================================

model Project {
  id            String   @id @default(uuid())
  userId        String
  tenantId      String
  
  // Basic info
  name          String
  status        String   @default("draft") // 'draft', 'locked', 'submitted', 'completed'
  
  // Product configuration
  productId     String?
  formatId      String?
  paperId       String?
  coverTypeId   String?
  
  // Calculated values
  pageCount     Int      @default(20)
  spineWidth    Float    @default(5) // mm, calculated
  
  // Dimensions (copied from format for snapshot)
  width         Float    @default(200) // mm
  height        Float    @default(200) // mm
  bleed         Float    @default(3) // mm
  safeMargin    Float    @default(5) // mm
  gutterMargin  Float    @default(10) // mm
  
  // Settings
  settings      String   @default("{}") // JSON for additional settings
  
  // Versioning
  currentVersion Int     @default(1)
  lockedAt      DateTime?
  lockedVersionId String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product?   @relation(fields: [productId], references: [id])
  format        Format?    @relation(fields: [formatId], references: [id])
  paper         Paper?     @relation(fields: [paperId], references: [id])
  coverType     CoverType? @relation(fields: [coverTypeId], references: [id])
  
  pages         Page[]
  versions      ProjectVersion[]
  assets        Asset[]
  orders        Order[]
  orderItems    OrderItem[]

  @@map("projects")
}

model Page {
  id            String   @id @default(uuid())
  projectId     String
  
  // Page info
  pageNumber    Int
  pageType      String   @default("regular") // 'regular', 'guard_front', 'guard_back', 'title', 'dedication'
  templateId    String?
  
  // Content
  elements      String   @default("[]") // JSON array of CanvasElement
  backgroundColor String @default("#ffffff")
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, pageNumber])
  @@map("pages")
}

model ProjectVersion {
  id            String   @id @default(uuid())
  projectId     String
  
  versionNumber Int
  data          String   // JSON snapshot of complete project state
  changesSummary String? // Brief description of changes
  isProduction  Boolean  @default(false) // locked production version
  
  createdAt     DateTime @default(now())

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, versionNumber])
  @@map("project_versions")
}


// ============================================
// ORDERS
// ============================================

model Order {
  id            String   @id @default(uuid())
  userId        String
  tenantId      String
  projectId     String
  
  // Order info
  orderNumber   String   @unique
  status        String   @default("draft") // 'draft', 'submitted', 'in_review', 'approved', 'rejected', 'in_production', 'completed', 'cancelled'
  
  // Product snapshot at order time
  productSnapshot String @default("{}") // JSON: {productName, formatName, paperName, coverType, pageCount, spineWidth}
  
  // Pricing
  subtotalAmount Float   @default(0)
  shippingCost   Float   @default(0)
  discountAmount Float   @default(0)
  totalAmount    Float   @default(0)
  
  // Payment
  paymentStatus  String  @default("PENDING") // 'PENDING', 'PAID', 'FAILED', 'REFUNDED'
  paymentMethod  String? // 'credit_card', 'pix', 'boleto'
  
  // Shipping
  shippingAddress String? // JSON with address details
  shippingMethod  String? // 'sedex', 'pac', 'pickup'
  trackingCode    String?
  
  // Notes
  notes          String?
  
  // Files
  coverPdfUrl   String?
  interiorPdfUrl String?
  
  // Timeline
  submittedAt   DateTime?
  reviewedAt    DateTime?
  approvedAt    DateTime?
  rejectedAt    DateTime?
  completedAt   DateTime?
  
  // Review
  reviewerId    String?
  rejectionReason String?
  reviewNotes   String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project  @relation(fields: [projectId], references: [id])
  reviewer      User?    @relation("OrderReviewer", fields: [reviewerId], references: [id])
  items         OrderItem[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  productId   String?
  projectId   String?
  quantity    Int      @default(1)
  unitPrice   Float    @default(0)
  totalPrice  Float    @default(0)
  createdAt   DateTime @default(now())

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])

  @@map("order_items")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String?
  
  // Event info
  eventType   String   // 'export', 'order_status_change', 'catalog_change', 'login_failed', etc.
  entityType  String?  // 'project', 'order', 'product', etc.
  entityId    String?
  
  // Details
  action      String   // 'create', 'update', 'delete', 'export', 'login', etc.
  details     String   @default("{}") // JSON with before/after values, etc.
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, eventType])
  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// COUPONS (Cupons de Desconto)
// ============================================

model Coupon {
  id            String    @id @default(uuid())
  tenantId      String
  code          String    // Código do cupom (ex: DESCONTO10)
  description   String?   // Descrição interna
  type          String    @default("percentage") // 'percentage' ou 'fixed'
  value         Float     // Valor do desconto (10 = 10% ou R$ 10)
  minPurchase   Float     @default(0) // Compra mínima para usar
  maxDiscount   Float?    // Desconto máximo (para percentual)
  maxUses       Int?      // Limite total de usos (null = ilimitado)
  maxUsesPerUser Int?     // Limite por usuário (null = ilimitado)
  usedCount     Int       @default(0) // Quantas vezes foi usado
  validFrom     DateTime? // Data início da validade
  validUntil    DateTime? // Data fim da validade
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  usages        CouponUsage[]

  @@unique([tenantId, code])
  @@map("coupons")
}

model CouponUsage {
  id          String   @id @default(uuid())
  couponId    String
  userId      String?
  orderId     String?
  discount    Float    // Valor do desconto aplicado
  usedAt      DateTime @default(now())

  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@map("coupon_usages")
}

// ============================================
// STUDIO - CLIENTS (CRM do Fotógrafo)
// ============================================

model Client {
  id            String    @id @default(uuid())
  userId        String    // Fotógrafo dono do cliente
  tenantId      String
  name          String
  email         String
  phone         String?
  address       String?
  notes         String?   // Observações sobre o cliente
  totalSpent    Float     @default(0) // Total gasto pelo cliente
  projectsCount Int       @default(0) // Contador de projetos
  lastProjectAt DateTime? // Data do último projeto
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  approvals     Approval[]

  @@unique([userId, email])
  @@index([userId, tenantId])
  @@map("clients")
}

// ============================================
// STUDIO - APPROVALS (Aprovações de Projetos)
// ============================================

model Approval {
  id            String    @id @default(uuid())
  userId        String    // Fotógrafo dono da aprovação
  tenantId      String
  projectId     String
  clientId      String?
  
  // Info do cliente (snapshot ou referência)
  clientName    String
  clientEmail   String
  
  // Status da aprovação
  status        String    @default("pending") // 'pending', 'viewed', 'approved', 'revision', 'rejected'
  
  // Link de aprovação
  token         String    @unique // Token único para link público
  expiresAt     DateTime? // Data de expiração do link
  
  // Tracking
  sentAt        DateTime  @default(now())
  viewedAt      DateTime?
  respondedAt   DateTime?
  
  // Feedback do cliente
  feedback      String?   // Comentários do cliente
  revisionNotes String?   // Notas de revisão solicitadas
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client        Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([userId, tenantId])
  @@index([projectId])
  @@index([token])
  @@map("approvals")
}
